<%- include("partials/navbar") %>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Statistiky rozhodčích</h1>


<!-- Filter Form -->
<form id="filterForm" method="get" class="flex flex-wrap items-center gap-4 mb-6">
  <!-- Competition -->
  <select name="competition" class="flex-1 min-w-[150px] border rounded px-2 py-1">
    <option value="">All</option>
    <% (filters.competitions || []).forEach(c => { %>
      <option value="<%= c.id %>" <%= activeFilters.competition == c.id ? "selected" : "" %>>
        <%= c.name %>
      </option>
    <% }) %>
  </select>

  <!-- Season -->
  <select name="season" class="flex-1 min-w-[150px] border rounded px-2 py-1">
    <option value="">All</option>
    <% (filters.seasons || []).forEach(s => { %>
      <option value="<%= s.id %>" <%= activeFilters.season == s.id ? "selected" : "" %>>
        <%= s.name %>
      </option>
    <% }) %>
  </select>

  <!-- Phase -->
  <select name="phase" class="flex-1 min-w-[150px] border rounded px-2 py-1">
    <option value="">All</option>
    <% (filters.phases || []).forEach(p => { %>
      <option value="<%= p.id %>" <%= activeFilters.phase == p.id ? "selected" : "" %>>
        <%= p.name %>
      </option>
    <% }) %>
  </select>

  <!-- Phase Detail -->
  <select name="phasedetail" class="flex-1 min-w-[150px] border rounded px-2 py-1">
    <option value="">All</option>
    <% (filters.phasedetails || []).forEach(pd => { %>
      <option value="<%= pd.id %>" <%= activeFilters.phasedetail == pd.id ? "selected" : "" %>>
        <%= pd.name %>
      </option>
    <% }) %>
  </select>

  <!-- Group By -->
  <select name="groupby" class="flex-1 min-w-[150px] border rounded px-2 py-1">
    <option value="">Overall</option>
    <option value="competition" <%= activeFilters.groupby === "competition" ? "selected" : "" %>>Competition</option>
    <option value="season" <%= activeFilters.groupby === "season" ? "selected" : "" %>>Season</option>
    <option value="phase" <%= activeFilters.groupby === "phase" ? "selected" : "" %>>Phase</option>
    <option value="phasedetail" <%= activeFilters.groupby === "phasedetail" ? "selected" : "" %>>Phase Detail</option>
  </select>

  <!-- Reset button -->
  <button type="button" id="resetFilters" class="bg-success text-white px-4 py-2 rounded">
    Reset Filters
  </button>
</form>




  <!-- Stats Table -->
  <table id="refereeTable" class="display">
    <thead>
      <tr class="bg-gray-200">
        <th class="border px-2 py-1">Rozhodčí</th>
        <th class="border px-2 py-1">Soutěž</th>
        <th class="border px-2 py-1">Sezóna</th>
        <th class="border px-2 py-1">Fáze</th>
        <th class="border px-2 py-1">Fáze Detail</th>
        <th class="border px-2 py-1">Zápasy</th>
        <th class="border px-2 py-1">Avg 2min</th>
        <th class="border px-2 py-1">Avg 5min</th>
        <th class="border px-2 py-1">&gt;5 2min</th>
        <th class="border px-2 py-1">&gt;6 2min</th>
        <th class="border px-2 py-1">&gt;7 2min</th>
        <th class="border px-2 py-1">&gt;8 2min</th>
        <th class="border px-2 py-1">&gt;9 2min</th>
        <th class="border px-2 py-1">&gt;10 2min</th>
      </tr>
    </thead>
    <tbody>
      <% stats.forEach(r => { %>
        <tr>
          <td class="border px-2 py-1"><a href="/referees/<%= r.referee_id %>"><%= r.referee_name %></a></td>
          <td class="border px-2 py-1"><%= r.competition_name %></td>
          <td class="border px-2 py-1"><%= r.season_name %></td>
          <td class="border px-2 py-1"><%= r.phase_name %></td>
          <td class="border px-2 py-1"><%= r.phasedetail_name %></td>
          <td class="border px-2 py-1"><%= r.matches %></td>
          <td class="border px-2 py-1"><%= r.avg_2min %></td>
          <td class="border px-2 py-1"><%= r.avg_5min %></td>
          <td class="border px-2 py-1"><%= r.pct_over_5 %> %</td>
          <td class="border px-2 py-1"><%= r.pct_over_6 %> %</td>
          <td class="border px-2 py-1"><%= r.pct_over_7 %> %</td>
          <td class="border px-2 py-1"><%= r.pct_over_8 %> %</td>
          <td class="border px-2 py-1"><%= r.pct_over_9 %> %</td>
          <td class="border px-2 py-1"><%= r.pct_over_10 %> %</td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<script>

$(document).ready(function() {
  // initialize DataTable once
  const table = $('#refereeTable').DataTable({
    paging: true,
    searching: true,
    order: [[5, 'desc']], // Matches column index (0-based): matches is column 5 in your layout
    pageLength: 25,
    lengthMenu: [10, 25, 50, 100]
  });

  // map form field name -> API param name
  const nameMap = {
    competition: 'competition_id',
    season: 'season_id',
    phase: 'phase_id',
    phasedetail: 'phasedetail_id',
    groupby: 'group'
  };

  // fetch & redraw table
  function fetchStats() {
    const params = new URLSearchParams();

    // collect values from selects and map to API query names
    $('#filterForm select').each(function() {
      const formName = this.name;
      const apiName = nameMap[formName] || formName;
      if (this.value) params.set(apiName, this.value);
    });

    const url = `https://beta.kenyschulz.com/referee/api/getrefstats.php?${params.toString()}`;

    $.ajax({
      url,
      method: 'GET',
      dataType: 'json',
      success: function(data) {
        const stats = data.stats || [];
        table.clear();

        stats.forEach(r => {
          // use placeholders for missing context fields
          const comp = (r.competition_name && r.competition_name !== '') ? r.competition_name : '—';
          const season = (r.season_name && r.season_name !== '') ? r.season_name : '—';
          const phase = (r.phase_name && r.phase_name !== '') ? r.phase_name : '—';
          const pd = (r.phasedetail_name && r.phasedetail_name !== '') ? r.phasedetail_name : '—';

          table.row.add([
            `<a href="/referees/${r.referee_id}">${r.referee_name}</a>`,
            comp,
            season,
            phase,
            pd,
            r.matches,
            r.avg_2min,
            r.avg_5min,
            (r.pct_over_5 !== null ? r.pct_over_5 + ' %' : '—'),
            (r.pct_over_6 !== null ? r.pct_over_6 + ' %' : '—'),
            (r.pct_over_7 !== null ? r.pct_over_7 + ' %' : '—'),
            (r.pct_over_8 !== null ? r.pct_over_8 + ' %' : '—'),
            (r.pct_over_9 !== null ? r.pct_over_9 + ' %' : '—'),
            (r.pct_over_10 !== null ? r.pct_over_10 + ' %' : '—')
          ]);
        });

        table.draw();
      },
      error: function(err) {
        console.error('Error fetching stats:', err);
        // optionally show message to user
      }
    });
  }

  // fetch on any filter change
  $('#filterForm select').on('change', fetchStats);

  // Reset filters button
  $('#resetFilters').on('click', function() {
    $('#filterForm select').val(''); // reset selects
    fetchStats();
  });

  // initial load
  fetchStats();
});
</script>
